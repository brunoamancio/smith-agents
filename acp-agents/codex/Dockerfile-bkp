FROM python:3.14-alpine

ARG CODEX_ACP_VERSION=0.4.0
ARG CODEX_ACP_TARGET=x86_64-unknown-linux-gnu
ARG CODEX_ACP_SHA256=ca531fce73e9c715599b3aea707713bc9883ea78d098384b6fdd63c46c5ea5d5

ENV PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    CODEX_ACP_VERSION=${CODEX_ACP_VERSION}

WORKDIR /app

RUN apk add --no-cache curl ca-certificates jq xxd

RUN python -m pip install --upgrade pip==25.3

RUN curl -fsSL "https://github.com/zed-industries/codex-acp/releases/download/v${CODEX_ACP_VERSION}/codex-acp-${CODEX_ACP_VERSION}-${CODEX_ACP_TARGET}.tar.gz" -o /tmp/codex-acp.tar.gz \
    && echo "${CODEX_ACP_SHA256}  /tmp/codex-acp.tar.gz" | sha256sum -c - \
    && tar -xzf /tmp/codex-acp.tar.gz -C /usr/local/bin \
    && chmod +x /usr/local/bin/codex-acp \
    && rm /tmp/codex-acp.tar.gz \
    && mkdir -p /workspace

COPY acp-agents/codex/requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir -r /app/requirements.txt

COPY acp-agents/codex/app /app/app
COPY acp_agents_common /app/acp_agents_common

ENV CODEX_ACP_BIN=/usr/local/bin/codex-acp \
    CODEX_WORKDIR=/workspace \
    CODEX_SESSION_PERSIST=1

EXPOSE 8080

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8080"]
